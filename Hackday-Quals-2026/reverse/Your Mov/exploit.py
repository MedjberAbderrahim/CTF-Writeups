#!/usr/bin/env python3
import subprocess

def run(binpath, arg):
    cmd = ["ltrace", "-f", "-s", "200", binpath, arg]
    p = subprocess.run(
        cmd,
        stdout=subprocess.PIPE,
        stderr=subprocess.STDOUT,
        text=True,
        errors="replace",
    )
    return p.stdout

def main():
    PREFIX = "HACKDAY{"
    SUFFIX = "aabaaacaaadaaaeaaafaaagaaahaaaiaaajaaakaaalaaamaaanaaaoaaapaaa}"

    max_cmps = 0
    max_cmps_id = f"{0:02x}"

    for i in range(0x00, 0x40, 0x02):
        for b in range(0x00, 0xff):
            flag = f"{PREFIX}{b:02x}{SUFFIX}"

            out = run('./your_mov', flag)
            cmps = out[out.find('memcpy(0x8601270, "HACKDAY", 7)'):].count('memcmp')

            if (cmps > max_cmps):
                max_cmps = cmps
                max_cmps_id = f"{b:02x}"

        PREFIX = f"{PREFIX}{max_cmps_id}"
        SUFFIX = SUFFIX[2:]

        print(f"\n-- TURN 0x{i:02x} --")
        print(f"max_cmps_id: {max_cmps_id}")
        print(f"current prefix: {PREFIX}")

        max_cmps = 0
        max_cmps_id = f"{0:02x}"
    
    PREFIX += '}'
    print(f'\nFlag: {PREFIX}')


main()